<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARTA MTD Sales Performance Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js and DataLabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <!-- Load PapaParse for CSV reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Custom Gradient Fill for Header */
        .header-gradient {
            background: linear-gradient(120deg, #11998e 0%, #6a0dad 100%); 
        }

        .gauge-meter {
            height: 10px;
            border-radius: 9999px;
            overflow: hidden;
            background-color: #e5e7eb; 
        }
        .gauge-fill {
            transition: width 0.7s ease-out;
            border-radius: 9999px;
            height: 100%; 
        }
        /* RAG Colors */
        .fill-green { background-color: #10b981; }
        .fill-amber { background-color: #f59e0b; }
        .fill-red { background-color: #ef4444; }
        .fill-blue { background-color: #3b82f6; }
        
        .ring-green { --tw-ring-color: #10b981; }
        .ring-amber { --tw-ring-color: #f59e0b; }
        .ring-red { --tw-ring-color: #ef4444; }
        .ring-blue { --tw-ring-color: #3b82f6; }

        .text-green { color: #10b981; }
        .text-amber { color: #f59e0b; }
        .text-red { color: #ef4444; }
        .text-blue { color: #3b82f6; }
        .text-red-600 { color: #dc2626; } 
        .text-green-600 { color: #059669; }

        .chart-bar {
            transition: width 0.7s ease-out;
            height: 100%;
            min-width: 1rem;
        }
        
        /* Tab Styles */
        .tab-button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; 
            font-weight: 500;
            font-size: 0.875rem; 
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
            cursor: pointer;
        }
        .tab-active {
            background-color: white;
            color: #11998e; 
            font-weight: 700;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .tab-inactive {
            background-color: transparent;
            color: #f4f7f9;
            opacity: 0.8;
            border-color: rgba(255, 255, 255, 0.2);
        }
        .tab-inactive:hover {
            opacity: 1;
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Trend Button Styles */
        .trend-btn {
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 0.375rem;
            border: 1px solid #e5e7eb;
            background-color: white;
            color: #4b5563;
            transition: all 0.2s;
        }
        .trend-btn:hover {
            background-color: #f9fafb;
            border-color: #d1d5db;
        }
        .trend-btn.active {
            background-color: #6a0dad; 
            color: white;
            border-color: #6a0dad;
        }
        
        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.95);
            z-index: 50;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #11998e;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Fix for sticky column */
        @media (min-width: 1024px) {
            .min-w-full th:first-child,
            .min-w-full td:first-child {
                position: sticky;
                left: 0;
                z-index: 10;
                box-shadow: 2px 0 3px -1px rgba(0, 0, 0, 0.05); 
            }
            .min-w-full td:first-child {
                background-color: white;
            }
            .min-w-full tfoot td:first-child {
                 background-color: #f3f4f6; 
            }
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Loading Screen -->
    <div id="loading-overlay">
        <div class="spinner mb-4"></div>
        <h2 class="text-xl font-bold text-gray-700">Connecting to Live Data...</h2>
        <p class="text-sm text-gray-500">Fetching Latest Updates</p>
        <p id="error-details" class="text-xs text-red-500 mt-2 hidden text-center max-w-md px-4"></p>
    </div>

    <div id="app" class="max-w-7xl mx-auto" style="display: none;">

        <!-- Header -->
        <header class="header-gradient p-6 rounded-xl shadow-xl mb-8 flex flex-col xl:flex-row justify-between items-start xl:items-center border border-gray-200">
            <div class="mb-4 xl:mb-0">
                <h1 class="text-3xl sm:text-4xl font-extrabold text-white">SPARTA MTD Sales Performance</h1>
                <p id="data-date" class="text-lg text-gray-200 mt-1">(Data as of ...)</p>
            </div>
            
            <div id="filter-controls" class="flex flex-wrap gap-2 p-2 bg-gray-900/10 rounded-lg shadow-inner border border-gray-400">
                <!-- Dropdowns inserted by JS -->
            </div>
        </header>

        <!-- KPI Cards -->
        <div id="kpi-cards" class="grid grid-cols-2 md:grid-cols-5 gap-6 md:gap-8 mb-6"></div>

        <!-- Tab Controls -->
        <div class="flex justify-center mb-6 z-10 relative">
            <div class="flex p-1 bg-gray-700/30 rounded-lg shadow-md backdrop-blur-sm">
                <button id="tab-territory" class="tab-button tab-active">Territory Update</button>
                <button id="tab-db" class="tab-button tab-inactive">DB Update</button>
                <button id="tab-sr" class="tab-button tab-inactive">DFF Update</button>
            </div>
        </div>

        <!-- Visuals Panel 1: Main -->
        <div id="visuals-panel-main" style="display: grid;" class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-10">

            <!-- Performance Status -->
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Performance Status (DB & SR)</h2>
                <p class="text-sm text-gray-500 mb-4">No. of performers Above 90%, 85-90%, and Below 85% of Time elapsed %.</p>
                <div id="sr-health" class="mb-6 border-b pb-4 border-gray-100"></div>
                <div id="db-health"></div>
            </div>

            <!-- Chart Section -->
            <div class="lg:col-span-2">
                <div id="territory-chart-container" style="display: block;" class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Territory STT Achievement vs. Target</h2>
                    <p class="text-sm font-semibold text-gray-500 mb-4">Time Elapsed Target: <span class="text-blue benchmark-text"></span> (Ranked by Achievement)</p>
                    <div id="stt-chart" class="space-y-4"></div>
                </div>

                <div id="db-chart-container" style="display: none;" class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">DB STT Achievement vs. Target (Aggregated)</h2>
                    <p class="text-sm font-semibold text-gray-500 mb-4">Time Elapsed Target: <span class="text-blue benchmark-text"></span> (Ranked by Achievement)</p>
                    <div id="db-stt-chart" class="space-y-4"></div>
                </div>
            </div>

            <!-- Combo Chart -->
            <div id="combo-chart-section" class="lg:col-span-3 bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">Daily Sales vs. ERC Trend</h2>
                        <p class="text-sm text-gray-500">Day-wise trend of STT Achievement (Line) vs. ERC Achievement (Column).</p>
                    </div>
                    <div class="flex flex-wrap items-center gap-3" id="trend-controls-wrapper">
                        <!-- DFF Trend Filter -->
                        <div class="flex flex-col">
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Filter Trend by DFF</label>
                            <select id="dff-trend-filter" class="py-1 px-2 border border-gray-300 rounded text-xs font-semibold text-gray-700 bg-white shadow-sm focus:ring-1 focus:ring-purple-500 outline-none min-w-[140px]">
                                <option value="All DFFs">All DFFs</option>
                            </select>
                        </div>
                        <!-- Period Buttons -->
                        <div class="flex flex-col">
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Time Period</label>
                            <div class="flex gap-1" id="trend-buttons">
                                <button class="trend-btn active" data-filter="MTD">MTD</button>
                                <button class="trend-btn" data-filter="L3D">L3D</button>
                                <button class="trend-btn" data-filter="W1">W1</button>
                                <button class="trend-btn" data-filter="W2">W2</button>
                                <button class="trend-btn" data-filter="W3">W3</button>
                                <button class="trend-btn" data-filter="W4">W4</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="relative h-80 md:h-96">
                    <canvas id="comboChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Visuals Panel 2: SR View -->
        <div id="visuals-panel-sr" style="display: none;" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-10">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Top 10 DFF Nationally (by STT Ach %)</h2>
                <p class="text-sm font-semibold text-gray-500 mb-4">Time Elapsed Target: <span class="text-blue benchmark-text"></span></p>
                <div id="top-10-sr-chart" class="space-y-4"></div>
            </div>
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Bottom 10 DFF Nationally (by STT Ach %)</h2>
                <p class="text-sm font-semibold text-gray-500 mb-4">Time Elapsed Target: <span class="text-blue benchmark-text"></span></p>
                <div id="bottom-10-sr-chart" class="space-y-4"></div>
            </div>
        </div>

        <!-- Tables -->
        <div id="tab-panels">
            <div id="panel-territory" style="display: block;">
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 mb-10">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Detailed Territory Performance MTD</h2>
                    <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase sticky left-0 bg-gray-50 z-20">Territory</th><th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">STT TGT (Lac)</th><th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">STT Ach (Lac)</th><th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">STT Ach %</th><th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">ERC TGT</th><th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">ERC Ach</th><th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">ERC Ach %</th><th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">SF TBR TGT</th><th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">SF TBR Ach</th><th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">SF TBR Ach %</th><th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">P.SKU TGT</th><th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">P.SKU Ach</th><th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">P.SKU Ach %</th></tr></thead><tbody id="territory-list" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                </div>
            </div>
            
            <div id="panel-db" style="display: none;">
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 mb-10">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Detailed DB Performance MTD (Aggregated)</h2>
                    <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase sticky left-0 bg-gray-50 z-20">DB Name</th><th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">STT TGT (Lac)</th><th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">STT Ach (Lac)</th><th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">STT Ach %</th><th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">ERC TGT</th><th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">ERC Ach</th><th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">ERC Ach %</th><th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">SF TBR TGT</th><th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">SF TBR Ach</th><th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">SF TBR Ach %</th><th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">P.SKU TGT</th><th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">P.SKU Ach</th><th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">P.SKU Ach %</th></tr></thead><tbody id="db-list" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                </div>
            </div>

            <div id="panel-sr" style="display: none;">
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 mb-10">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Detailed DFF Performance MTD</h2>
                    <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase sticky left-0 bg-gray-50 z-20">DFF Name</th><th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">STT TGT (Lac)</th><th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">STT Ach (Lac)</th><th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">STT Ach %</th><th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">ERC TGT</th><th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">ERC Ach</th><th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">ERC Ach %</th><th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">SF TBR Ach</th><th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">P.SKU TGT</th><th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">P.SKU Ach</th><th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">P.SKU Ach %</th></tr></thead><tbody id="sr-list" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        Chart.register(ChartDataLabels);

        // --- URLS UPDATED ---
        const MTD_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSW3e0Hgotn4crFK1ac2osytnFt7jaWlVSV5a1BURK-3zLU_Q9-LxbyTuCCMLa4tbO3-9nLhttdk-1v/pub?output=csv';
        const CHART_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSW3e0Hgotn4crFK1ac2osytnFt7jaWlVSV5a1BURK-3zLU_Q9-LxbyTuCCMLa4tbO3-9nLhttdk-1v/pub?gid=573142787&single=true&output=csv';

        // --- DYNAMIC VARIABLES ---
        let timeElapsedPercent = 0; 
        let daysPassed = "";
        let totalWorkingDaysInMonth = 26;
        const LAC_DIVISOR = 100000;
        
        let selectedFilters = {
            'Area': 'All Areas',
            'Territory': 'All Territories',
            'DB Name': 'All DBs',
            'DFF Name': 'All DFFs' // Added DFF filter state
        };
        
        let activeTab = 'territory';
        let activeTrendFilter = 'MTD';
        
        let areaSelect, territorySelect, dbNameSelect, dffTrendSelect;
        let comboChartInstance = null;

        let rawSrData = [];
        let dailyRawData = [];
        let processedTerritoryData = [];
        let processedDbData = [];

        function parseNumeric(value) {
            if (typeof value === 'number') return value;
            if (typeof value === 'string') {
                if (value.toLowerCase().includes('k')) {
                    const number = parseFloat(value.toLowerCase().replace('k', '').replace(/,/g, ''));
                    return isNaN(number) ? 0 : number * 1000; 
                }
                const cleanedValue = value.replace(/,/g, '').replace(/%/g, '');
                const number = parseFloat(cleanedValue);
                return isNaN(number) ? 0 : number;
            }
            return 0;
        }

        function countWorkingDays(year, month, limitDay) {
            let count = 0;
            for(let d = 1; d <= limitDay; d++) {
                const dayOfWeek = new Date(year, month, d).getDay();
                if(dayOfWeek !== 5) count++; 
            }
            return count;
        }

        function calculatePercentages(data) {
            if (!data) return {};
            data.sttAchPercent = (data.sttTgt > 0) ? (data.sttAch / data.sttTgt) * 100 : 0;
            data.ercAchPercent = (data.ercTgt > 0) ? (data.ercAch / data.ercTgt) * 100 : 0;
            data.sfTbrAchPercent = (data.sfTbrTgt > 0) ? (data.sfTbrAch / data.sfTbrTgt) * 100 : 0;
            data.premiumSkuAchPercent = (data.premiumSkuGoal > 0) ? (data.premiumSkuAch / data.premiumSkuGoal) * 100 : 0;
            return data;
        }

        function getRAGStatus(percentage) {
            const val = percentage || 0;
            const benchmarkHigh = timeElapsedPercent * 0.90;
            const benchmarkLow = timeElapsedPercent * 0.85;
            if (val >= benchmarkHigh) return { color: 'fill-green', text: 'Green', ring: 'ring-green', textColor: 'text-green' };
            else if (val >= benchmarkLow) return { color: 'fill-amber', text: 'Amber', ring: 'ring-amber', textColor: 'text-amber' };
            else return { color: 'fill-red', text: 'Red', ring: 'ring-red', textColor: 'text-red' };
        }

        function formatInLac(amount) {
            return (amount / LAC_DIVISOR).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function formatCount(amount) {
            return Math.round(amount || 0).toLocaleString('en-US', { maximumFractionDigits: 0 });
        }
        
        function formatValue(value, unit) {
            return unit === "Lac" ? formatInLac(value) : formatCount(value);
        }

        function calculateGrandTotals(dataArray) {
            const totals = {
                sttTgt: 0, sttAch: 0, ercTgt: 0, ercAch: 0, 
                sfTbrTgt: 0, sfTbrAch: 0, premiumSkuGoal: 0, premiumSkuAch: 0
            };
            dataArray.forEach(data => {
                for (const key in totals) {
                    const val = parseNumeric(data[key]);
                    if (!isNaN(val)) totals[key] += val;
                }
            });
            return calculatePercentages(totals);
        }

        async function fetchCsvData(url) {
            const timestampedUrl = `${url}&t=${Date.now()}`;
            try {
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(timestampedUrl)}`;
                const response = await fetch(proxyUrl);
                if (response.ok) {
                    const jsonData = await response.json();
                    if (jsonData.contents) return parseCsv(jsonData.contents);
                }
            } catch (e) { console.warn("Proxy failed", e); }
            try {
                const response = await fetch(timestampedUrl);
                if (response.ok) return parseCsv(await response.text());
            } catch (e) { console.error("Direct fetch failed", e); }
            throw new Error("Unable to fetch data.");
        }

        function parseCsv(csvText) {
            return new Promise((resolve) => {
                Papa.parse(csvText, {
                    header: true, skipEmptyLines: true,
                    complete: (results) => resolve(results.data)
                });
            });
        }

        async function initDashboard() {
            try {
                const [mtdData, chartData] = await Promise.all([
                    fetchCsvData(MTD_DATA_URL),
                    fetchCsvData(CHART_DATA_URL)
                ]);

                rawSrData = mtdData.map(sr => ({
                    area: sr['AREA'] || sr['Area'],
                    territory: sr['TERRITORY'] || sr['Territory'],
                    tm: sr['TM'],
                    lead: sr['LEAD'],
                    dhCode: sr['DH CODE'] || sr['DH Code'], 
                    dhName: sr['DH NAME'] || sr['DH Name'],
                    dffCode: sr['DFF CODE'] || sr['DFF Code'],
                    dffName: sr['DFF NAME'] || sr['DFF Name'],
                    sttTgt: parseNumeric(sr['STT TGT']),
                    sttAch: parseNumeric(sr['MTD ACH']),
                    ercTgt: parseNumeric(sr['ERC TGT']),
                    ercAch: parseNumeric(sr['ERC ACH']),
                    sfTbrTgt: parseNumeric(sr['SF TBR (MAX LIMIT)']),
                    sfTbrAch: parseNumeric(sr['SF TBR ERC ACH']), 
                    premiumSkuGoal: parseNumeric(sr['PREMIUM SKU ERC GOAL']),
                    premiumSkuAch: parseNumeric(sr['PREMIUM SKU ERC ACH'])
                }));

                dailyRawData = chartData.map(row => ({
                    calday: row['CALDAY'],
                    sales: parseNumeric(row['SALES']),
                    erc: parseNumeric(row['ERC']),
                    AREA: row['AREA'],
                    TERRITORY: row['TERRITORY'],
                    DISTRIBUTOR_NAME: row['DISTRIBUTOR_NAME'],
                    DFF_NAME: row['DFF_NAME'] // Map DFF Name for trend filtering
                }));

                let maxDate = new Date();
                if (dailyRawData.length > 0) {
                    const sortedDates = dailyRawData
                        .map(r => new Date(r.calday))
                        .filter(d => !isNaN(d.getTime()))
                        .sort((a,b) => b - a);
                    if (sortedDates.length > 0) maxDate = sortedDates[0];
                }

                const day = maxDate.getDate();
                const monthName = maxDate.toLocaleString('default', { month: 'short' });
                const suffix = (d) => {
                    if (d > 3 && d < 21) return 'th';
                    switch (d % 10) {
                        case 1:  return "st";
                        case 2:  return "nd";
                        case 3:  return "rd";
                        default: return "th";
                    }
                };
                document.getElementById('data-date').innerText = `(Data as of ${monthName} ${day}${suffix(day)})`;

                const currentYear = maxDate.getFullYear();
                const currentMonth = maxDate.getMonth();
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
                const passed = countWorkingDays(currentYear, currentMonth, day);
                const total = countWorkingDays(currentYear, currentMonth, daysInMonth);
                
                totalWorkingDaysInMonth = total;
                daysPassed = `${passed} out of ${total}`;
                timeElapsedPercent = (total > 0) ? (passed / total) * 100 : 0;
                
                document.querySelectorAll('.benchmark-text').forEach(el => el.textContent = `${timeElapsedPercent.toFixed(2)}%`);

                preProcessData();
                initializeFilters();
                applyFilters(); 
                
                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('app').style.display = 'block';

            } catch (error) {
                console.error("Init Error:", error);
                document.querySelector('#loading-overlay h2').innerText = "Connection Failed";
                document.getElementById('error-details').innerText = error.message;
                document.getElementById('error-details').classList.remove('hidden');
            }
        }

        function preProcessData() {
            rawSrData = rawSrData.map(sr => calculatePercentages(sr));

            const nationallySortedSrs = [...rawSrData].sort((a, b) => (b.sttAchPercent || 0) - (a.sttAchPercent || 0));
            nationallySortedSrs.forEach((sr, index) => {
                sr.nationalRank = index + 1;
            });

            const territoryMap = new Map();
            rawSrData.forEach(sr => {
                const key = sr.territory;
                if (!territoryMap.has(key)) {
                    territoryMap.set(key, {
                        territory: sr.territory, tm: sr.tm, area: sr.area,
                        sttTgt: 0, sttAch: 0, ercTgt: 0, ercAch: 0,
                        sfTbrTgt: 0, sfTbrAch: 0, premiumSkuGoal: 0, premiumSkuAch: 0
                    });
                }
                const t = territoryMap.get(key);
                t.sttTgt += sr.sttTgt; t.sttAch += sr.sttAch;
                t.ercTgt += sr.ercTgt; t.ercAch += sr.ercAch;
                t.sfTbrTgt += sr.sfTbrTgt; t.sfTbrAch += sr.sfTbrAch;
                t.premiumSkuGoal += sr.premiumSkuGoal; t.premiumSkuAch += sr.premiumSkuAch;
            });
            
            const dbMap = new Map();
            rawSrData.forEach(sr => {
                const key = sr.dhName;
                if (!dbMap.has(key)) {
                    dbMap.set(key, {
                        dhName: sr.dhName, area: sr.area, territory: sr.territory,
                        sttTgt: 0, sttAch: 0, ercTgt: 0, ercAch: 0,
                        sfTbrTgt: 0, sfTbrAch: 0, premiumSkuGoal: 0, premiumSkuAch: 0
                    });
                }
                const db = dbMap.get(key);
                db.sttTgt += sr.sttTgt; db.sttAch += sr.sttAch;
                db.ercTgt += sr.ercTgt; db.ercAch += sr.ercAch;
                db.sfTbrTgt += sr.sfTbrTgt; db.sfTbrAch += sr.sfTbrAch;
                db.premiumSkuGoal += sr.premiumSkuGoal; db.premiumSkuAch += sr.premiumSkuAch;
            });

            processedTerritoryData = Array.from(territoryMap.values()).map(item => calculatePercentages(item));
            processedDbData = Array.from(dbMap.values()).map(item => calculatePercentages(item));
        }

        function getAggregatedDailyData() {
            const aggMap = new Map();
            const filteredDailyData = dailyRawData.filter(row => {
                const matchArea = selectedFilters.Area === 'All Areas' || row.AREA === selectedFilters.Area;
                const matchTerritory = selectedFilters.Territory === 'All Territories' || row.TERRITORY === selectedFilters.Territory;
                const matchDb = selectedFilters['DB Name'] === 'All DBs' || row.DISTRIBUTOR_NAME === selectedFilters['DB Name'];
                const matchDff = selectedFilters['DFF Name'] === 'All DFFs' || row.DFF_NAME === selectedFilters['DFF Name'];
                return matchArea && matchTerritory && matchDb && matchDff;
            });

            filteredDailyData.forEach(row => {
                const rawDate = row.calday;
                if (!aggMap.has(rawDate)) {
                    const dateObj = new Date(rawDate);
                    const label = dateObj.toLocaleDateString('en-US', { month: 'short', day: '2-digit' });
                    aggMap.set(rawDate, { date: rawDate, label, sales: 0, erc: 0 });
                }
                const entry = aggMap.get(rawDate);
                entry.sales += row.sales;
                entry.erc += row.erc;
            });

            return Array.from(aggMap.values())
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .map(d => ({ dateObj: new Date(d.date), label: d.label, sales: d.sales / LAC_DIVISOR, erc: d.erc }));
        }

        function filterTrendData(data, filterType) {
            if (filterType === 'L3D') return data.slice(-3);
            if (filterType === 'W1') return data.filter(d => d.dateObj.getDate() >= 1 && d.dateObj.getDate() <= 7);
            if (filterType === 'W2') return data.filter(d => d.dateObj.getDate() >= 8 && d.dateObj.getDate() <= 14);
            if (filterType === 'W3') return data.filter(d => d.dateObj.getDate() >= 15 && d.dateObj.getDate() <= 21);
            if (filterType === 'W4') return data.filter(d => d.dateObj.getDate() >= 22);
            return data;
        }

        function populateDateWiseChart(filterType = 'MTD', totalTarget = 0) {
            const ctx = document.getElementById('comboChart');
            if (!ctx) return; 
            let chartDataRaw = filterTrendData(getAggregatedDailyData(), filterType);

            const labels = chartDataRaw.map(d => `${d.label} (${d.dateObj.toLocaleDateString('en-US', { weekday: 'short' })})`);
            const barBackgroundColors = chartDataRaw.map(d => d.dateObj.getDay() === 5 ? 'rgba(239, 68, 68, 0.8)' : 'rgba(17, 153, 142, 0.7)');
            const barBorderColors = chartDataRaw.map(d => d.dateObj.getDay() === 5 ? 'rgba(220, 38, 38, 1)' : 'rgba(17, 153, 142, 1)');
            
            if (comboChartInstance) comboChartInstance.destroy();

            comboChartInstance = new Chart(ctx, {
                type: 'bar', 
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'ERC Ach', data: chartDataRaw.map(d => d.erc), type: 'line', borderColor: '#6a0dad', backgroundColor: '#6a0dad', borderWidth: 3, tension: 0.4, yAxisID: 'y1', order: 1, datalabels: { align: 'top', anchor: 'start', color: '#6a0dad', font: { weight: 'bold', size: 11 }, offset: 4 }},
                        { label: 'Sales (Lac)', data: chartDataRaw.map(d => d.sales), type: 'bar', backgroundColor: barBackgroundColors, borderColor: barBorderColors, borderWidth: 1, borderRadius: 4, yAxisID: 'y', order: 2, datalabels: { align: 'end', anchor: 'end', color: '#0d7a71', font: { weight: 'bold', size: 10 }, formatter: v => (v || 0).toFixed(2) }}
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, layout: { padding: { top: 25 }},
                    plugins: { tooltip: { mode: 'index', intersect: false }, legend: { position: 'bottom' }, datalabels: { display: true, clip: false }},
                    scales: { x: { display: true }, y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Sales (Lac)' } }, y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'ERC Ach (Count)' }, grid: { drawOnChartArea: false } } }
                }
            });
        }

        function applyFilters() {
            let filteredSrs = [...rawSrData];
            if (selectedFilters.Area !== 'All Areas') filteredSrs = filteredSrs.filter(data => data.area === selectedFilters.Area);
            if (selectedFilters.Territory !== 'All Territories') filteredSrs = filteredSrs.filter(data => data.territory === selectedFilters.Territory);
            if (selectedFilters['DB Name'] !== 'All DBs') filteredSrs = filteredSrs.filter(data => data.dhName === selectedFilters['DB Name']);
            
            // Special local DFF filtering for KPIs and Status (Global Filter logic)
            // Note: The Trend Chart uses selectedFilters['DFF Name'] separately handled in getAggregatedDailyData
            
            const activeTerritories = new Set(filteredSrs.map(sr => sr.territory));
            const activeDbNames = new Set(filteredSrs.map(sr => sr.dhName));
            
            const filteredTerritories = processedTerritoryData.filter(t => activeTerritories.has(t.territory));
            const filteredDbs = processedDbData.filter(db => activeDbNames.has(db.dhName));

            const totals = calculateGrandTotals(filteredSrs);
            populateKpiCards(updateKpiData(totals));
            populateTable('territory-list', filteredTerritories, 'territory', 'tm');
            populateTable('db-list', filteredDbs, 'dhName', 'territory');
            populateTable('sr-list', filteredSrs, 'dffName', 'dhName'); 
            
            populateTerritoryChart(filteredTerritories);
            populateDbChart(filteredDbs);
            populateTopBottomSrCharts(filteredSrs);
            updateSrStatus(filteredSrs); 
            updateDbStatus(filteredDbs); 
            populateDateWiseChart(activeTrendFilter, totals.sttTgt);
        }

        function initializeTrendButtons() {
            document.querySelectorAll('.trend-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.trend-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    activeTrendFilter = btn.getAttribute('data-filter');
                    applyFilters();
                });
            });

            // Initialize DFF Trend Filter listener
            dffTrendSelect = document.getElementById('dff-trend-filter');
            dffTrendSelect.addEventListener('change', (e) => {
                selectedFilters['DFF Name'] = e.target.value;
                applyFilters(); // Re-run all filters including chart
            });
        }

        function initializeFilters() {
            const controls = document.getElementById('filter-controls');
            controls.innerHTML = '';
            
            const areas = [...new Set(rawSrData.map(i => i.area))].sort();
            const territories = [...new Set(rawSrData.map(i => i.territory))].sort();
            const dbNames = [...new Set(rawSrData.map(i => i.dhName))].sort();
            
            const areaDrop = createFilterDropdown('Area', ['All Areas', ...areas]);
            areaSelect = areaDrop.select;
            const terrDrop = createFilterDropdown('Territory', ['All Territories', ...territories]);
            territorySelect = terrDrop.select;
            const dbDrop = createFilterDropdown('DB Name', ['All DBs', ...dbNames]);
            dbNameSelect = dbDrop.select;

            controls.append(areaDrop.wrapper, terrDrop.wrapper, dbDrop.wrapper);
            
            // Initial population of DFF trend select
            updateDependentFilters('Init');
        }

        function createFilterDropdown(name, options) {
            const wrapper = document.createElement('div');
            wrapper.className = 'flex flex-col text-sm';
            const label = document.createElement('label');
            label.textContent = name;
            label.className = 'text-xs font-semibold text-gray-200 mb-1 pl-1';
            const select = document.createElement('select');
            select.className = 'py-2 px-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-gray-700 bg-white cursor-pointer';
            
            options.forEach(opt => {
                const el = document.createElement('option');
                el.value = opt; el.textContent = opt;
                select.appendChild(el);
            });

            select.addEventListener('change', (e) => {
                selectedFilters[name] = e.target.value;
                updateDependentFilters(name);
                applyFilters();
            });

            wrapper.append(label, select);
            return { wrapper, select };
        }

        function updateDependentFilters(changed) {
            let srs = [...rawSrData];
            if (selectedFilters.Area !== 'All Areas') srs = srs.filter(s => s.area === selectedFilters.Area);
            if (changed === 'Area' || changed === 'Init') {
                const terrs = ['All Territories', ...new Set(srs.map(s => s.territory).sort())];
                updateSelectOptions(territorySelect, terrs, 'Territory');
            }
            if (selectedFilters.Territory !== 'All Territories') srs = srs.filter(s => s.territory === selectedFilters.Territory);
            if (changed === 'Area' || changed === 'Territory' || changed === 'Init') {
                const dbs = ['All DBs', ...new Set(srs.map(s => s.dhName).sort())];
                updateSelectOptions(dbNameSelect, dbs, 'DB Name');
            }
            
            // Link DFF Trend Filter with the hierarchy
            if (changed !== 'TrendDFF') {
                const filteredSrs = rawSrData.filter(s => {
                    const matchArea = selectedFilters.Area === 'All Areas' || s.area === selectedFilters.Area;
                    const matchTerritory = selectedFilters.Territory === 'All Territories' || s.territory === selectedFilters.Territory;
                    const matchDb = selectedFilters['DB Name'] === 'All DBs' || s.dhName === selectedFilters['DB Name'];
                    return matchArea && matchTerritory && matchDb;
                });
                const dffs = ['All DFFs', ...new Set(filteredSrs.map(s => s.dffName).sort())];
                updateSelectOptions(document.getElementById('dff-trend-filter'), dffs, 'DFF Name');
            }
        }

        function updateSelectOptions(select, options, key) {
            if (!select) return;
            const current = selectedFilters[key];
            select.innerHTML = '';
            options.forEach(opt => {
                const el = document.createElement('option');
                el.value = opt; el.textContent = opt;
                select.appendChild(el);
            });
            select.value = options.includes(current) ? current : options[0];
            selectedFilters[key] = select.value;
        }

        function initializeTabs() {
            const tabs = ['tab-territory', 'tab-db', 'tab-sr'];
            tabs.forEach(tabId => {
                document.getElementById(tabId).addEventListener('click', () => {
                    tabs.forEach(id => {
                        const btn = document.getElementById(id);
                        btn.classList.remove('tab-active'); btn.classList.add('tab-inactive');
                    });
                    document.getElementById(tabId).classList.add('tab-active');
                    document.getElementById(tabId).classList.remove('tab-inactive');

                    ['panel-territory', 'panel-db', 'panel-sr', 'territory-chart-container', 'db-chart-container', 'visuals-panel-main', 'visuals-panel-sr'].forEach(id => {
                        document.getElementById(id).style.display = 'none';
                    });

                    if (tabId === 'tab-territory') {
                        document.getElementById('panel-territory').style.display = 'block';
                        document.getElementById('territory-chart-container').style.display = 'block';
                        document.getElementById('visuals-panel-main').style.display = 'grid';
                    } else if (tabId === 'tab-db') {
                        document.getElementById('panel-db').style.display = 'block';
                        document.getElementById('db-chart-container').style.display = 'block';
                        document.getElementById('visuals-panel-main').style.display = 'grid';
                    } else {
                        document.getElementById('panel-sr').style.display = 'block';
                        document.getElementById('visuals-panel-sr').style.display = 'grid';
                    }
                });
            });
        }

        function updateKpiData(totals) {
            const newKpiData = {
                timeElapsed: { label: "Time Elapsed", percentage: timeElapsedPercent, valueText: daysPassed + " Working Days Passed", rag: { color: 'fill-blue', text: 'Benchmark', textColor: 'text-blue', ring: 'ring-blue' }, isBenchmark: true },
                mtdStt: { label: "MTD STT Ach", percentage: totals.sttAchPercent || 0, unit: "Lac", target: totals.sttTgt, achieved: totals.sttAch },
                mtdErc: { label: "MTD ERC Ach", percentage: totals.ercAchPercent || 0, unit: "Stores", target: totals.ercTgt, achieved: totals.ercAch },
                sfTbr: { label: "SF TBR Vol.", percentage: (totals.sfTbrTgt > 0 ? (totals.sfTbrAch/totals.sfTbrTgt)*100 : 0), unit: "TBRs", target: totals.sfTbrTgt, achieved: totals.sfTbrAch },
                premiumTp: { label: "Premium TP Ach", percentage: totals.premiumSkuAchPercent || 0, unit: "Stores", target: totals.premiumSkuGoal, achieved: totals.premiumSkuAch }
            };
            ['mtdStt', 'mtdErc', 'sfTbr', 'premiumTp'].forEach(k => newKpiData[k].rag = getRAGStatus(newKpiData[k].percentage));
            return newKpiData;
        }

        function createKpiCard(kpi) {
            const rag = kpi.rag;
            const perc = kpi.percentage || 0;
            let mainValue = kpi.isBenchmark ? perc.toFixed(2) + '%' : (kpi.label.includes('SF TBR') ? formatCount(kpi.achieved) : perc.toFixed(2) + '%');
            let subContent = kpi.isBenchmark ? `<p class="text-sm text-gray-500 mt-2 font-medium">${kpi.valueText}</p>` : '';

            if (!kpi.isBenchmark) {
                const bal = kpi.target - kpi.achieved;
                const diff = perc - timeElapsedPercent;
                const diffHtml = !kpi.label.includes('SF TBR') ? `<div class="flex justify-between items-center text-gray-600"><span class="text-xs font-medium">vs. Time Elapsed:</span><span class="font-bold text-sm ${diff < 0 ? 'text-red-600' : 'text-green-600'}">${diff > 0 ? '+' : ''}${diff.toFixed(2)}%</span></div>` : '';
                
                subContent = `
                    <div class="mt-3 pt-3 border-t border-gray-100 space-y-1 text-sm">
                        ${diffHtml}
                        <div class="space-y-1 pt-1 border-t border-gray-100">
                             ${!kpi.label.includes('SF TBR') ? `<div class="flex justify-between text-gray-600"><span class="text-xs">TGT:</span><span class="font-bold text-gray-700">${formatValue(kpi.target, kpi.unit)}</span></div>` : ''}
                             <div class="flex justify-between text-gray-600"><span class="text-xs">Ach:</span><span class="font-bold ${rag.textColor}">${formatValue(kpi.achieved, kpi.unit)}</span></div>
                             ${!kpi.label.includes('SF TBR') ? `<div class="flex justify-between text-gray-600"><span class="text-xs">Bal:</span><span class="font-bold ${bal > 0 ? 'text-red-500' : 'text-gray-500'}">${formatValue(bal, kpi.unit)}</span></div>` : ''}
                        </div>
                    </div>`;
            }

            return `
                <div class="bg-white p-6 rounded-xl shadow-xl border border-gray-100 ${kpi.isBenchmark ? 'col-span-2 md:col-span-1' : ''}">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-sm font-medium text-gray-500">${kpi.label}</p>
                        <span class="w-3 h-3 rounded-full ${rag.color.replace('fill-', 'bg-')} ring-2 ring-offset-2 ${rag.ring}"></span>
                    </div>
                    <div class="text-3xl md:text-4xl font-extrabold mt-1 ${rag.textColor}">${mainValue}</div>
                    <div class="gauge-meter mt-4 mb-3"><div class="gauge-fill ${rag.color}" style="width: ${Math.min(100, perc).toFixed(2)}%"></div></div>
                    ${subContent}
                </div>`;
        }

        function populateKpiCards(kpiData) {
            const container = document.getElementById('kpi-cards');
            container.innerHTML = '';
            ['timeElapsed', 'mtdStt', 'mtdErc', 'sfTbr', 'premiumTp'].forEach(key => {
                if (kpiData[key]) container.insertAdjacentHTML('beforeend', createKpiCard(kpiData[key]));
            });
        }

        function populateTable(id, data, nameKey, subKey) {
            const tbody = document.getElementById(id);
            const table = tbody.closest('table');
            if (table.tFoot) table.tFoot.remove();
            tbody.innerHTML = '';

            if (!data || data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="13" class="text-center py-4 text-gray-500">No data found.</td></tr>`;
                return;
            }

            data.sort((a, b) => (b.sttAchPercent || 0) - (a.sttAchPercent || 0)).forEach(row => {
                const sttC = getRAGStatus(row.sttAchPercent).textColor;
                const ercC = getRAGStatus(row.ercAchPercent).textColor;
                const pskuC = getRAGStatus(row.premiumSkuAchPercent).textColor;
                const sfC = getRAGStatus(row.sfTbrAchPercent).textColor;

                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900 sticky left-0 bg-white z-10 shadow-sm">${row[nameKey]}<div class="text-xs text-gray-500">${row[subKey] || ''}</div></td>
                    <td class="px-3 py-3 text-center text-sm text-gray-500">${formatInLac(row.sttTgt)}</td>
                    <td class="px-3 py-3 text-center text-sm font-medium ${sttC}">${formatInLac(row.sttAch)}</td>
                    <td class="px-3 py-3 text-center text-sm font-bold ${sttC}">${(row.sttAchPercent || 0).toFixed(2)}%</td>
                    <td class="px-3 py-3 text-center text-sm text-gray-500">${formatCount(row.ercTgt)}</td>
                    <td class="px-3 py-3 text-center text-sm font-medium ${ercC}">${formatCount(row.ercAch)}</td>
                    <td class="px-3 py-3 text-center text-sm font-bold ${ercC}">${(row.ercAchPercent || 0).toFixed(2)}%</td>
                    <td class="px-3 py-3 text-center text-sm text-gray-500">${formatCount(row.sfTbrTgt)}</td>
                    <td class="px-3 py-3 text-center text-sm font-medium ${sfC}">${formatCount(row.sfTbrAch)}</td>
                    <td class="px-3 py-3 text-center text-sm font-bold ${sfC}">${(row.sfTbrAchPercent || 0).toFixed(2)}%</td>
                    <td class="px-3 py-3 text-center text-sm text-gray-500">${formatCount(row.premiumSkuGoal)}</td>
                    <td class="px-3 py-3 text-center text-sm font-medium ${pskuC}">${formatCount(row.premiumSkuAch)}</td>
                    <td class="px-3 py-3 text-center text-sm font-bold ${pskuC}">${(row.premiumSkuAchPercent || 0).toFixed(2)}%</td>
                `;
                tbody.appendChild(tr);
            });

            const t = calculateGrandTotals(data);
            const foot = document.createElement('tfoot');
            foot.className = 'bg-gray-100 font-bold border-t-2 border-gray-300';
            foot.innerHTML = `<tr>
                <td class="px-3 py-3 sticky left-0 bg-gray-100 z-10">GRAND TOTAL</td>
                <td class="px-3 py-3 text-center text-gray-700">${formatInLac(t.sttTgt)}</td>
                <td class="px-3 py-3 text-center text-gray-900">${formatInLac(t.sttAch)}</td>
                <td class="px-3 py-3 text-center ${getRAGStatus(t.sttAchPercent).textColor}">${(t.sttAchPercent || 0).toFixed(2)}%</td>
                <td class="px-3 py-3 text-center text-gray-700">${formatCount(t.ercTgt)}</td>
                <td class="px-3 py-3 text-center text-gray-900">${formatCount(t.ercAch)}</td>
                <td class="px-3 py-3 text-center ${getRAGStatus(t.ercAchPercent).textColor}">${(t.ercAchPercent || 0).toFixed(2)}%</td>
                <td class="px-3 py-3 text-center text-gray-700">${formatCount(t.sfTbrTgt)}</td>
                <td class="px-3 py-3 text-center text-gray-900">${formatCount(t.sfTbrAch)}</td>
                <td class="px-3 py-3 text-center ${getRAGStatus(t.sfTbrAchPercent).textColor}">${(t.sfTbrAchPercent || 0).toFixed(2)}%</td>
                <td class="px-3 py-3 text-center text-gray-700">${formatCount(t.premiumSkuGoal)}</td>
                <td class="px-3 py-3 text-center text-gray-900">${formatCount(t.premiumSkuAch)}</td>
                <td class="px-3 py-3 text-center ${getRAGStatus(t.premiumSkuAchPercent).textColor}">${(t.premiumSkuAchPercent || 0).toFixed(2)}%</td>
            </tr>`;
            table.appendChild(foot);
        }

        function createBarChart(containerId, dataArray, labelKey, subKey) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if (!dataArray || dataArray.length === 0) { container.innerHTML = '<div class="text-center py-8 text-gray-500">No data</div>'; return; }

            dataArray.forEach((d, i) => {
                const perc = d.sttAchPercent || 0;
                const rag = getRAGStatus(perc);
                const width = Math.min(100, perc).toFixed(2);
                const gap = perc - timeElapsedPercent;
                
                const rank = d.nationalRank || (i + 1);

                const item = document.createElement('div');
                item.className = 'flex items-center text-sm';
                item.innerHTML = `
                    <div class="w-1/4 truncate mr-4">
                        <div class="font-bold text-gray-900 truncate">#${rank} ${d[labelKey]}</div>
                        <div class="text-xs text-gray-500 truncate">${d[subKey] || ''}</div>
                    </div>
                    <div class="w-3/4 bg-gray-200 rounded-full h-8 flex items-center relative">
                        <div class="absolute h-full w-[2px] bg-blue-500 border-l border-dashed border-blue-700 z-10" style="left: ${timeElapsedPercent}%"></div>
                        <div class="h-full rounded-full flex items-center justify-end pr-2 text-white font-bold text-xs ${rag.color}" style="width: ${width}%">
                            ${perc > 15 ? perc.toFixed(1) + '%' : ''}
                        </div>
                        <span class="absolute right-2 text-xs font-bold ${gap >= 0 ? 'text-green-600' : 'text-red-600'}">GAP: ${gap > 0 ? '+' : ''}${gap.toFixed(2)}%</span>
                         ${perc <= 15 ? `<span class="absolute left-2 text-xs font-bold ${rag.textColor}">${perc.toFixed(1)}%</span>` : ''}
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function populateTerritoryChart(data) { createBarChart('stt-chart', data, 'territory', 'tm'); }
        function populateDbChart(data) { createBarChart('db-stt-chart', data, 'dhName', 'territory'); }
        function populateTopBottomSrCharts(data) {
            const sorted = [...(data || [])].sort((a,b) => (b.sttAchPercent || 0) - (a.sttAchPercent || 0));
            createBarChart('top-10-sr-chart', sorted.slice(0, 10), 'dffName', 'dhName');
            createBarChart('bottom-10-sr-chart', sorted.slice(-10).reverse(), 'dffName', 'dhName');
        }

        function updateSrStatus(data) {
            const status = { green: 0, amber: 0, red: 0, total: (data || []).length };
            (data || []).forEach(d => {
                const s = getRAGStatus(d.sttAchPercent).text;
                if(s==='Green') status.green++; else if(s==='Amber') status.amber++; else status.red++;
            });
            renderHealthBar('sr-health', 'DFF', status);
        }

        function updateDbStatus(data) {
            const status = { green: 0, amber: 0, red: 0, total: (data || []).length };
            (data || []).forEach(d => {
                const s = getRAGStatus(d.sttAchPercent).text;
                if(s==='Green') status.green++; else if(s==='Amber') status.amber++; else status.red++;
            });
            renderHealthBar('db-health', 'DB', status);
        }

        function renderHealthBar(id, label, s) {
            const gp = s.total > 0 ? (s.green/s.total)*100 : 0;
            const ap = s.total > 0 ? (s.amber/s.total)*100 : 0;
            const rp = s.total > 0 ? (s.red/s.total)*100 : 0;
            document.getElementById(id).innerHTML = `
                <h3 class="text-md font-semibold text-gray-700 mb-2">${label} Status (Total: ${s.total})</h3>
                <div class="flex h-6 rounded-full overflow-hidden text-xs font-semibold">
                    <div class="chart-bar fill-green text-center text-white p-1" style="width: ${gp}%">${s.green || ''}</div>
                    <div class="chart-bar fill-amber text-center text-white p-1" style="width: ${ap}%">${s.amber || ''}</div>
                    <div class="chart-bar fill-red text-center text-white p-1" style="width: ${rp}%">${s.red || ''}</div>
                </div>
                <div class="flex justify-between text-xs mt-1">
                    <span class="text-green">Above 90%: ${s.green}</span>
                    <span class="text-amber">85-90%: ${s.amber}</span>
                    <span class="text-red">Below 85%: ${s.red}</span>
                </div>
            `;
        }

        initDashboard();
        initializeTabs();
        initializeTrendButtons();

    </script>
</body>
</html>
